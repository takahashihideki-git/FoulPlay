<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>CSV Base</title>
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/ActivityIndicator.css">
<style>
  body {
    padding: 1em;
    padding-bottom: 2em;
    margin-bottom: 3em;
  }
  .tables {
    position: relative;
    padding: 2em 1em 1em;
    min-height: 100px;
    background-color:#eee;
    border-radius: 1em;
    -webkit-user-select: none;
  }
  .tableContainer {
    display: inline-block;
    margin-right: 1em;
    padding-bottom: 2em;
  }
  .joinContainer {
    display: inline-block;
    margin-right: 1em;
    padding-bottom: 2em;
  }
  .tables .table {
    position: relative;
    display: table-cell;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
  }
  .tables .tips {
    position: absolute;
    left: 1em;
    bottom: 0px;
    margin: 3px;
    color: #999;
  }
  .joinContainer .table {
    border: 1px dashed #ccc;
  }
  .tables .table.selected {
    background-color: #F5F3CB;
  }
  .tables .table.refresh {
    color: #fff;
    background-color: #2ea2dc;
  }
  .table-name {
    margin: 0;
    padding: 0.5em;
    border-bottom: 1px solid #ccc;
    font-size: 100%;
    font-weight: bold;
  }
  .table-titles {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
  .table-titles li {
    padding: 0.2em 0.5em;
    border-bottom: 1px dotted #ccc;
    font-size: 90%;
  }
  .table-titles li:last-child {
    border: 0;
  }
  .table-count {
    position: absolute;
    top: -10px;
    right: -10px;
    padding: 0 0.5em;
    border-radius: 10px;
    background-color: #2ea2dc;
    color: #fff;
    font-size: 80%;
  }
  .table-icon {
    position: absolute;
    bottom: -20px;
    width: 16px;
    height: 16px;
    background-color: #333;
    border-radius: 16px;
    background-size: cover;
  }
  .table-icon-refresh {
    left: 0;
    background-image: url( "css/img/ic_refresh_white_48dp.png" );
  }
  .table-icon-remove {
    right: 0;
    background-image: url( "css/img/ic_close_white_48dp.png" );
  }
  .button-import {
    position: absolute;
    width: 6em;
    top: 1em;
    right: 1em;
    z-index: 1;
  }
  .records {
    position: relative;
    padding: 1em;
    background-color: #333;
    border-radius: 1em;
    color: #eee;
  }
  .records-scroller {
    max-height: 200px;
    margin-bottom: 1em;
    overflow-y: scroll;
  }
  .records table {
    width: 100%;  
    margin: 1em 0;
  }
  .records th,
  .records td {
    padding: 0.2em 0.5em;
  }
  .records th {
    border-bottom: 1px solid #666;
    word-break: break-word;
  }
  .records td {
    border-bottom: 1px dotted #ccc;
    word-break: break-word;
  }
  .records-count {
    padding-left: 0.5em;
    font-weight: bold;
  }
  .condition,
  .query {
    position: relative;
    margin: 1em 0;
    padding: 1em;
    border: 1px solid #ccc;
    border-radius: 1em;
  }
  .condition table,
  .query table {
    width: 100%;
  }
  .condition th,
  .condition td,
  .query th,
  .query td {
    padding: 0.2em 0.5em;
  }
  .condition th,
  .query th {
    width: 100px;
  }
  .condition input[type=text],
  .query input[type=text] {
    width: 90%;
    padding: 0 0.2em;
    font-family: monospace;
    letter-spacing: 0.05em;
  }
  .condition input[type=checkbox],
  .query input[type=checkbox] {
    vertical-align: -2px;
    margin-right: 0.5em;
  }
  .button-condition,
  .button-query,
  .button-save  {
    position: absolute;
    width: 6em;
    z-index: 1;
  }
  .button-condition,
  .button-query {
    top: 1.1em;
    right: 1em;
  }
  .button-save {
    bottom: -3em;
    right: 1em;
    color: #000;
  }
  label {
    font-weight: normal;
  }
  code {
    padding: 2px 4px;
    font-size: 90%;
    color: #4a4a4a;
    background-color: #f7f7f7;
    border-radius: 10px;
  }
  .template {
    display: none;
  }
</style>
</head>
<body>

<header>
  <h1>CSV Base</h1>
</header>

<div class="tables">
  <button class="button button-import">Import</button>
  <p class="tips" style="display:none">Click to select a table. Shift Key + click to join two tables.</p>
</div>

<div class="condition" style="display:none">
  <form>
    <table>
      <tr>
        <th>Join:</th>
        <td>
          <input type="text">
        </td>
      </tr>
      <tr>
          <th></th>
          <td>Enter a join condition as list of some pairs of left table column and right table column. e.g.<code>[ [ "column1", "column3" ], [ "column2", "column4" ] ]</code></td>
      </tr>
      <tr>
          <th></th>
          <td><label><input type="checkbox">select unmached records</label></td>
      </tr>
    </table>
  </form>
  <button class="button button-condition">Apply</button>
</div>

<div class="query" style="display:none">
  <form>
    <table>
      <tr>
        <th>Query:</th>
        <td>
          <input name="query" type="text">
        </td>
      </tr>
      <tr>
          <th></th>
          <td>Enter <a href="http://www.taffydb.com/writingqueries" target="syntax">a filter object for Taffy DB.</a> e.g.<code>{ column1: "value1" }</code> <code>{ column1: { ">": 100 } }</code> <code>{  column1: { like: "foo" }}</code></td>
      </tr>
      <tr>
        <th>Order:</th>
        <td>
          <input name="order" type="text">
        </td>
      </tr>
      <tr>
        <th></th>
        <td>Enter a list of columns to order by. e.g. <code>["column"]</code> <code>["column1", "column2"]</code><code>["fieldname1 asc", "fieldname2 desc"]</code></td> 
      </tr>
      <tr>
        <th>Distinct:</th>
        <td><input name="distinct" type="text"></td>
      </tr>
      <tr>
        <th></th>
        <td>Enter a list of columns of distinct value. e.g. <code>["column1"]</code> <code>["column1","column2"]</code></td>
      </tr>
    </table>
  </form>
  <button class="button button-query">Apply</button>
</div>

<div class="records" style="display:none">
  <div class="records-scroller">
    <table>
      <thead>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <div class="records-count"></div>
  <button class="button button-save">Save</button>
</div>

<div class="globalSpinner-container" style="display:none">
  <img class="globalSpinner-spinner" src="css/img/ActivityIndicator.png" style="-webkit-animation-name: dashcode-activity-indicator; -webkit-animation-duration: 1s; -webkit-animation-iteration-count: infinite; -webkit-animation-timing-function: linear;" />
</div>

<script type="text/x-template" class="template template-table">
  <div class="table">
    <h3 class="table-name">{NAME}</h3>
    <ul class="table-titles">
    {FOREACH TITLES}<li>{TITLE}</li>{/FOREACH}
    </ul>
    <div class="table-count">{COUNT}</div>
    <div class="table-icon table-icon-refresh" style="display:none"></div>
    <div class="table-icon table-icon-remove" style="display:none"></div>
  </div>
</script>

<script type="text/x-template" class="template template-titles">
  <tr>
    {FOREACH TITLES}<th>{TITLE}</th>{/FOREACH}
  </tr>
</script>

<script type="text/x-template" class="template template-values">
  <tr>
    {FOREACH VALUES}<td>{VALUE}</td>{/FOREACH}
  </tr>
</script>

<script type="text/javascript" src="js/script.js"></script>
<script>
/**
constant
*/
const PATH = require( "path" );

/**
Database Class
*/
var Database = function ( args ) {

  this.tablesContainer = args.tablesContainer;
  this.conditionContainer = args.conditionContainer;
  this.queryContainer = args.queryContainer;
  this.recordsContainer = args.recordsContainer;
  this.tables = new Object();
  this.joins = new Object();
  this.setConditionForm();
  this.setQueryForm();
  this.setSaveButton();

}
Database.prototype = {

  tablesContainer: null,
  queryContainer: null,
  recordsContainer: null,
  tables: null,
  joins: null,
  selectedTable: null,
  template: {
    titles: document.querySelector( ".template-titles" ).innerHTML,
    values: document.querySelector( ".template-values" ).innerHTML
  },
  records: null,

  setConditionForm: function () {

    var db = this;

    this.conditionContainer.querySelector( ".button-condition" ).addEventListener( "click", function () {
      var conditions = db.conditionContainer.querySelector( "input[type=text]" ).value;
      var isReverse = db.conditionContainer.querySelector( "input[type=checkbox]" ).checked;
      window.globalSpinner.start();
      setTimeout( function () {
        db.selectedTable.setConditions( conditions, isReverse );
        db.showRecords( db.selectedTable.get( db.selectedTable.lastQuery.expr, db.selectedTable.lastQuery.order, db.selectedTable.lastQuery.distinct ) );
        window.globalSpinner.stop();
      }, 500 );
    } );

  },

  initConditionForm: function () {
    this.conditionContainer.querySelector( "input[type=text]" ).value = "";
    this.conditionContainer.querySelector( "input[type=checkbox]" ).checked = false;
    this.conditionContainer.style.display = "block";
    if ( this.selectedTable && this.selectedTable.lastConditionExpr ) {
      this.conditionContainer.querySelector( "input" ).value = this.selectedTable.lastConditionExpr;
      if ( this.selectedTable.isReverse ) {
        this.conditionContainer.querySelector( "input[type=checkbox]" ).checked = true;
      }
    }
  },

  hideConditionForm: function () {
    this.conditionContainer.querySelector( "input" ).value = "";
    this.conditionContainer.style.display = "none";
  },

  setQueryForm: function () {

    var db = this;

    this.queryContainer.querySelector( ".button-query" ).addEventListener( "click", function () {
      var expr = db.queryContainer.querySelector( "input[name=query]" ).value;
      var order = db.queryContainer.querySelector( "input[name=order]" ).value;
      var distinct = db.queryContainer.querySelector( "input[name=distinct]" ).value;
      window.globalSpinner.start();
      setTimeout( function () {
        db.showRecords( db.selectedTable.get( expr, order, distinct ) );
        window.globalSpinner.stop();
      }, 500 );
    } );

  },

  initQueryForm: function () {
    this.queryContainer.querySelector( "input" ).value = "";
    this.queryContainer.style.display = "block";
    if ( this.selectedTable && this.selectedTable.lastQuery ) {
      this.queryContainer.querySelector( "input[name=query]" ).value = this.selectedTable.lastQuery.expr;
      this.queryContainer.querySelector( "input[name=order]" ).value = this.selectedTable.lastQuery.order;
      this.queryContainer.querySelector( "input[name=distinct]" ).value = this.selectedTable.lastQuery.distinct;
    }
  },

  hideQueryForm: function () {
    this.queryContainer.querySelector( "input" ).value = "";
    this.queryContainer.style.display = "none";
  },

  setSaveButton: function () {

    var db = this;

    this.recordsContainer.querySelector( ".button-save" ).addEventListener( "click", function () {
      db.saveRecordsAsNewCsv();
    } );

  },

  initSaveButton: function () {
    this.recordsContainer.querySelector( ".button-save" ).style.display = "block"
  },

  hideSaveButton: function () {
    this.recordsContainer.querySelector( ".button-save" ).style.display = "none"
  },

  importCsv: function ( path, table ) {

    var db = this;

    if ( path ) {
      window.globalSpinner.start();
    }

    window.fileSystem.open( {
      path: path,
      success: function ( path, data ) {
        window.globalSpinner.start();
        if ( table ) {
          table.reset( Papa.parse( data.replace( /[\r\n]+$/, "" ) ).data );
          if ( db.selectedTable == table ) {
              db.showRecords( table.get( table.lastQuery.expr, table.lastQuery.order, table.lastQuery.distinct ) );
          }
        }
        else {
          db.createTable( path, Papa.parse( data.replace( /[\r\n]+$/, "" ) ).data );
        }
        window.globalSpinner.stop();
      },
      error: function ( path, data ) {
        alert( path + " " + data );
        window.globalSpinner.stop();
      }
    } );

  },

  createTable: function ( path, data ) {

    var name = PATH.basename( path ).replace( /\.[^\.]+$/, "" );

    if ( this.tables[ name ] ) {
      alert( name + " already exist." );
      return;
    }

    var titles = data.shift();
    var records = new Array();

    for ( var i = 0; i < data.length; i++ ) {
      ( function () {
        var record = {};
        for ( var j = 0; j < titles.length; j++ ) {
          record[ titles[ j ] ] = data[ i ][ j ];
        }
        records.push( record )
      } )();
    }

    this.tables[ name ] = new Table( {
      path: path,
      name: name,
      records: records,
      database: this
    } );

    this.appendTableComponent( this.tables[ name ] );

  },

  removeTable: function ( table ) {
    if ( this.selectedTable == table ) {
      this.unselectTable();
    }
    this.tablesContainer.removeChild( table.component );
    delete this.tables[ table.name ];
    delete table;
    if ( Object.keys( this.tables ).length == 0 ) {
      this.tablesContainer.querySelector( ".tips" ).style.display = "none";
    }
  },

  createJoin: function ( left, right ) {

    var name = left.name + "-" + right.name;

    if ( this.joins[ name ] ) {
      alert( "These tables have already joined." );
      return;
    }

    this.joins[ name ] = new Join( {
      name: name,
      left: left,
      right: right,
      conditions: [],
      database: this
    } );

    this.appendTableComponent( this.joins[ name ] );

  },

  removeJoin: function ( join ) {
    if ( this.selectedTable == join ) {
      this.unselectTable();
    }
    this.tablesContainer.removeChild( join.component );
    delete this.joins[ join.name ];
    delete join;
  },

  isIncludedInJoin: function ( table ) {
    var db = this;
    var joinNames = Object.keys( this.joins );
    var status = false;
    for ( var i = 0; i < joinNames.length; i++ ) {
      if ( db.joins[ joinNames[ i ] ].left == table || db.joins[ joinNames[ i ] ].right == table ) {
        status = true;
        break;
      }
    }
    return status;
  },

  appendTableComponent: function ( table ) {
    this.tablesContainer.appendChild( table.makeComponent() );
    this.tablesContainer.querySelector( ".tips" ).style.display = "block";
  },

  selectTable: function ( table, event ) {

    if ( table.isSelected ) {
      this.unselectTable();
    }
    else {

      if ( this.selectedTable && event.shiftKey ) { // add join

        if ( table instanceof Join ) {
          return;
        }

        this.createJoin( this.selectedTable, table  );

      }
      else { // change selected table

        var tableNames = Object.keys( this.tables );
        for ( var i = 0; i < tableNames.length; i++ ) {
          this.tables[ tableNames[ i ] ].unselect();
        }
        var joinNames = Object.keys( this.joins );
        for ( var i = 0; i < joinNames.length; i++ ) {
          this.joins[ joinNames[ i ] ].unselect();
        }

        table.select();
        this.selectedTable = table;

        this.initQueryForm();
        if ( table instanceof Join ) {
          this.initConditionForm();
        }
        else {
          this.hideConditionForm();
        }

        this.showRecords( table.get( table.lastQuery.expr, table.lastQuery.order, table.lastQuery.distinct ) );

      }

    }

  },

  unselectTable: function () {
      this.hideConditionForm();
      this.hideQueryForm();
      this.hideRecords();
      this.hideSaveButton();
      this.selectedTable.unselect();
      this.selectedTable = null;
  },

  initRecords: function () {
    this.recordsContainer.style.display = "block";
  },

  hideRecords: function () {
    this.records = null;
    this.recordsContainer.style.display = "none";
  },

  showRecords: function ( records ) {

    if ( ! records || ! records.length ) {
      this.hideRecords();
      return;
    }

    this.initRecords();
    this.initSaveButton();

    var db = this;

    // titles line
    var titlesLine = this.template.titles;
    var titles = Object.keys( records[ 0 ] );
    var titlesLoopTemplate = this.template.titles.replace( /^[\s\S]*?{FOREACH TITLES}([\s\S]*?)({TITLE})([\s\S]*?){\/FOREACH}[\s\S]*$/, function ( a, b, c, d ) { return b + c + d }  );
    var titlesLoop = "";
    for ( var i = 0; i < titles.length; i++ ) {
      if ( titles[ i ] != "___id" && titles[ i ] != "___s" && titles[ i ] != "___id_R" && titles[ i ] != "___s_R" ) {
        titlesLoop += titlesLoopTemplate.replace( /{TITLE}/, titles[ i ] );
      }
    }
    this.recordsContainer.querySelector( "table thead" ).innerHTML = titlesLine.replace( /{FOREACH TITLES}.*{\/FOREACH}/, titlesLoop );

    // values line
    var recordsLines = "";
    var valuesLoopTemplate = this.template.values.replace( /^[\s\S]*?{FOREACH VALUES}([\s\S]*?)({VALUE})([\s\S]*?){\/FOREACH}[\s\S]*$/, function ( a, b, c, d ) { return b + c + d }  );
    for ( var i = 0; i < records.length; i++ ) {
      ( function () {
        var valuesLine = db.template.values;
        var valuesLoop = "";
        for ( var j = 0; j < titles.length; j++ ) {
          if ( titles[ j ] != "___id" && titles[ j ] != "___s" && titles[ j ] != "___id_R" && titles[ j ] != "___s_R" ) {
            valuesLoop += valuesLoopTemplate.replace( /{VALUE}/, records[ i ][ titles[ j ] ] );
          }
        }
        recordsLines += valuesLine.replace( /{FOREACH VALUES}.*{\/FOREACH}/, valuesLoop );
      } )();
    }

    this.recordsContainer.querySelector( "table tbody" ).innerHTML = recordsLines;
    this.recordsContainer.querySelector( ".records-count" ).innerHTML = records.length;

    this.records = records;

  },

  saveRecordsAsNewCsv: function () {

    var db = this;

    if ( ! this.records ) {
      return;
    }

    var data = new Array();
    var titles = Object.keys( this.records[ 0 ] ).filter( function ( title ) {
      if ( title != "___id" && title != "___s" ) {
        return true;
      }
      return false;
    } );
    data.push( titles );
    for ( var i = 0; i < db.records.length; i++ ) {
      ( function () {

        var values = new Array();
        for ( var j = 0; j < titles.length; j++ ) {
          values.push( db.records[ i ][ titles[ j ] ] );
        }

        data.push( values );

      } )();
    }

    window.fileSystem.save( {
      path: "",
      content: Papa.unparse( data ),
      success: function ( path ) {
        db.importCsv( path );
      },
      error: function ( path, data ) {
        alert( path + " " + data );
      }
    } );

  }

}

/**
Get Method for Table / Join
*/
var getter = function ( expr, order, distinct ) {

  this.lastQuery = {
    expr: expr,
    order: order,
    distinct: distinct
  };

  var query;

  if ( ! this.lastQuery.expr ) {
      query = this.query();
  }
  else {
    try {
      eval( "var query = " + this.lastQuery.expr );
      query = this.query( query );
    } catch ( e ) {
      alert( e );
    }
  }

  if ( this.lastQuery.order ) {
    try {
      var order = JSON.parse( this.lastQuery.order );
      query = query.order( order.join( " " ) );
    } catch ( e ) { 
      alert( e );
      query = this.query( query );
    }
  }

  if ( this.lastQuery.distinct ) {
    try {
      var distincts = JSON.parse( this.lastQuery.distinct );
      var values = query.distinct.apply( query, JSON.parse( this.lastQuery.distinct ) );
      var records = new Array();
      for ( var i = 0; i < values.length; i++ ) { ( function () {
        var record = new Object();
        for ( var j = 0; j < distincts.length; j++ ) {
          if ( values[ i ] instanceof Array ) {
            record[ distincts[ j ] ] = values[ i ][ j ];
          }
          else {
            record[ distincts[ j ] ] = values[ i ]; 
          }
        }
        records.push( record );          
      } )() }
      return records;
    }
    catch ( e ) {
      alert( e );
      return query.get();
    }
  }
  else {
    return query.get();
  }

}

/**
Table Class
*/
var Table = function ( args ) {
  this.path = args.path;
  this.name = args.name;
  this.records = args.records;
  this.database = args.database;
  this.index = new Object();
  this.lastQuery = { expr: "", order: "", distinct: "" };
  this.initialize();
}
Table.prototype = {

  path: "",
  name : "",
  records: null,
  query: null,
  index: null,
  template: document.querySelector( ".template-table" ).innerHTML,
  database: null,
  component: null,
  isSelected: false,
  lastQuery: null,

  initialize: function () {
    this.query = TAFFY( this.records );
  },

  reset: function ( records ) {

    var table = this;

    this.records = records;
    this.initialize();

    this.component.querySelector( ".table-count" ).innerHTML = this.query().count();

    setTimeout( function () {
      table.component.querySelector( ".table" ).setAttribute( "class", table.component.querySelector( ".table" ).getAttribute( "class" ).replace( /refresh/, "" ).replace( / +/, " " ).replace( / $/, "" ) );
      setTimeout( function () {
        table.component.querySelector( ".table" ).style.transition = "none";
      }, 1000 );
    }, 1000 );

  },

  makeIndex: function (　field　) {

    this.index[ field ] = new Object();

    var records = this.query().get();
    
    for ( var i = 0; i < records.length; i++ ) {
      
      if ( field == "___id" ) {
        this.index[ field ][ records[ i ][ field ] ] = records[ i ];
      }
      else {
        if ( ! this.index[ field ][ records[ i ][ field ] ] ) {
          this.index[ field ][ records[ i ][ field ] ] = new Array();        
        }
        this.index[ field ][ records[ i ][ field ] ].push( records[ i ][ "___id" ] );
      }

    }

  },

  makeComponent: function () {

    var table = this;

    var tableComponent = this.template.replace( /{NAME}/, this.name )
                                      .replace( /{COUNT}/, this.query().count() );
    var titlesLoopTemplate = this.template.replace( /^[\s\S]*?{FOREACH TITLES}([\s\S]*?)({TITLE})([\s\S]*?){\/FOREACH}[\s\S]*$/, function ( a, b, c, d ) { return b + c + d }  );
    var titlesLoop = "";
    var titles = Object.keys( this.records[ 0 ] );
    for ( var i = 0; i < titles.length; i++ ) {
      if ( titles[ i ] != "___id" && titles[ i ] != "___s" ) {
        titlesLoop += titlesLoopTemplate.replace( /{TITLE}/, titles[ i ] );
      }
    }
    tableComponent = tableComponent.replace( /{FOREACH TITLES}.*{\/FOREACH}/, titlesLoop );

    this.component = document.createElement( "div" );
    this.component.innerHTML = tableComponent;
    this.component.setAttribute( "class", "tableContainer" );

    this.component.querySelector( ".table" ).addEventListener( "click", function ( event ) {
      window.globalSpinner.start();
      setTimeout( function () {
        table.database.selectTable( table, event );
        window.globalSpinner.stop();
      }, 500 );
    } );

    this.component.addEventListener( "mouseenter", function () {
      var icons = table.component.querySelectorAll( ".table-icon" );
      for ( var i = 0; i < icons.length; i++ ) {
        icons[ i ].style.display = "block";
      }
    } );

    this.component.addEventListener( "mouseleave", function () {
      var icons = table.component.querySelectorAll( ".table-icon" );
      for ( var i = 0; i < icons.length; i++ ) {
        icons[ i ].style.display = "none";
      }
    } );

    this.component.querySelector( ".table-icon-refresh" ).addEventListener( "click", function ( event ) {
      event.preventDefault();
      event.stopPropagation();
      table.refresh();
    } );

    this.component.querySelector( ".table-icon-remove" ).addEventListener( "click", function ( event ) {
      event.preventDefault();
      event.stopPropagation();
      table.remove();
    } );

    return this.component;

  },

  select: function () {
    this.isSelected = true;
    this.component.querySelector( ".table" ).setAttribute( "class", "table selected" );
  },

  unselect: function () {
    this.isSelected = false;
    this.component.querySelector( ".table" ).setAttribute( "class", "table" );
  },

  get: window.getter,

  refresh: function () {

    this.component.querySelector( ".table" ).style.transition = "background-color 1s linear,color 1s linear";
    this.component.querySelector( ".table" ).setAttribute( "class" , this.component.querySelector( ".table" ).getAttribute( "class" ) + " refresh" );
    this.database.importCsv( this.path, this );

  },

  remove: function () {

    if ( this.database.isIncludedInJoin( this ) ) {
      alert( 'Can not remove. "' + this.name + '" is included in any joins.' );
      return;
    }

    if ( confirm( 'Remove "' + this.name + '"?' ) ) {
      this.database.removeTable( this );
    }

  }

}

/**
Join Class
*/
var Join = function ( args ) {

  this.name = args.name;
  this.left = args.left;
  this.right = args.right;
  this.isReverse = args.isReverse;
  this.database = args.database;
  this.lastQuery = { expr: "", order: "", distinct: "" };
  this.initialize();

}
Join.prototype = {

  name: "",
  left: null,
  right: null,
  conditions: null,
  query: null,
  matchedLeftIds: null,
  template: document.querySelector( ".template-table" ).innerHTML,
  database: null,
  component: null,
  isSelected: false,
  isReverse: null,
  lastConditionExpr: "",
  lastQuery: null,

  initialize: function () {

    var join = this;
    
    if ( ! join.conditions || ! join.conditions.length ) {
      this.query = TAFFY( this.left.query().get() );
      return;
    }

    this.left.makeIndex( "___id" );
    this.right.makeIndex( "___id" );

    for ( var i = 0; i < join.conditions.length; i++ ) {

      this.right.makeIndex( join.conditions[ i ][ 1 ] );

    }

    var joinIndex = new Array();
    var leftRecords = this.left.query().get();

    for ( var i = 0; i < leftRecords.length; i++ ) { ( function () {

        var matchedIdCounter = new Object();

        for ( var j = 0; j < join.conditions.length; j++ ) { ( function () {

          var matchedIds = join.right.index[ join.conditions[ j ][ 1 ] ][ leftRecords[ i ][ join.conditions[ j ][ 0 ] ] ]
          matchedIds = matchedIds ? matchedIds : new Array(); 
            for ( var k = 0; k < matchedIds.length; k++ ) {
              if ( matchedIdCounter[ matchedIds[ k ] ] ) {
                matchedIdCounter[ matchedIds[ k ] ]++;
              }
              else {
                matchedIdCounter[ matchedIds[ k ] ] = 1; 
              }
            }

        } )() }

        var candidates = Object.keys( matchedIdCounter );
        var matchedIds = new Array();
        for ( var k = 0; k < candidates.length; k++ ) {
          if ( matchedIdCounter[ candidates[ k ] ] == join.conditions.length ) {
            matchedIds.push( candidates[ k ] ); 
          }
        }

        joinIndex.push( {
          left: leftRecords[ i ][ "___id" ],
          right: matchedIds
        } );

    } )() }

    var joinRecords = new Array();

    if ( ! this.isReverse ) {

      for ( var i = 0; i < joinIndex.length; i++ ) { ( function () {
        if ( joinIndex[ i ].right.length ) {
          var leftRecord = join.left.index[ "___id" ][ joinIndex[ i ].left ];
          var leftFields = Object.keys( leftRecord );
          for ( var j = 0; j < joinIndex[ i ].right.length; j++ ) { ( function () {
            var joinRecord = new Object();
            var rightRecord = join.right.index[ "___id" ][ joinIndex[ i ].right[ j ] ];
            var rightFields = Object.keys( rightRecord );
            for ( var k = 0; k < leftFields.length; k++ ) {
              joinRecord[ leftFields[ k ] ] = leftRecord[ leftFields[ k ] ]
            }
            for ( var k = 0; k < rightFields.length; k++ ) { ( function () {
              var suffix = "";
              if ( leftRecord[ rightFields[ k ] ] ) {
                suffix = "_R";
              }
              joinRecord[ rightFields[ k ] + suffix ] = rightRecord[ rightFields[ k ] ];
            } )() }
            joinRecords.push( joinRecord );
          } )() }
        }
      } )() }

    }
    else { // this.isReverse

      for ( var i = 0; i < joinIndex.length; i++ ) { ( function () {
        if ( ! joinIndex[ i ].right.length ) {
          joinRecords.push( join.left.index[ "___id" ][ joinIndex[ i ].left ] );
        }
      } )() }

    }

    this.query = TAFFY( joinRecords );

  },

  makeComponent: function () {

    var join = this;

    var joinComponent = this.template.replace( /{NAME}/, "JOIN" )
                                     .replace( /{COUNT}/, "" );
    var titlesLoopTemplate = this.template.replace( /^[\s\S]*?{FOREACH TITLES}([\s\S]*?)({TITLE})([\s\S]*?){\/FOREACH}[\s\S]*$/, function ( a, b, c, d ) { return b + c + d }  );
    var titlesLoop = "";
    var titles = [ "left:" + this.left.name, "right:" + this.right.name ];
    for ( var i = 0; i < titles.length; i++ ) {
      titlesLoop += titlesLoopTemplate.replace( /{TITLE}/, titles[ i ] );
    }
    joinComponent = joinComponent.replace( /{FOREACH TITLES}.*{\/FOREACH}/, titlesLoop );

    this.component = document.createElement( "div" );
    this.component.innerHTML = joinComponent;
    this.component.setAttribute( "class", "joinContainer" );

    this.component.querySelector( ".table" ).addEventListener( "click", function ( event ) {
      window.globalSpinner.start();
      setTimeout( function () {
        join.database.selectTable( join, event );
        window.globalSpinner.stop();
      }, 500 );
    } );

    this.component.addEventListener( "mouseenter", function () {
      var icons = join.component.querySelectorAll( ".table-icon" );
      for ( var i = 0; i < icons.length; i++ ) {
        icons[ i ].style.display = "block";
      }
    } );

    this.component.addEventListener( "mouseleave", function () {
      var icons = join.component.querySelectorAll( ".table-icon" );
      for ( var i = 0; i < icons.length; i++ ) {
        icons[ i ].style.display = "none";
      }
    } );

    this.component.querySelector( ".table-icon-refresh" ).addEventListener( "click", function ( event ) {
      event.preventDefault();
      event.stopPropagation();
      join.refresh();
    } );

    this.component.querySelector( ".table-icon-remove" ).addEventListener( "click", function ( event ) {
      event.preventDefault();
      event.stopPropagation();
      join.remove();
    } );

    return this.component;

  },

  select: function () {
    this.isSelected = true;
    this.component.querySelector( ".table" ).setAttribute( "class", "table selected" );
  },

  unselect: function () {
    this.isSelected = false;
    this.component.querySelector( ".table" ).setAttribute( "class", "table" );
  },

  setConditions: function ( expr, isReverse ) {

    this.lastConditionExpr = expr;
    this.conditions = null;
    if ( this.lastConditionExpr ) {
      try {
        eval( "var conditions = " + this.lastConditionExpr );
        this.conditions = conditions;
      } catch ( e ) {
        alert( e );
      }
    }

    this.isReverse = isReverse;

    this.initialize();

  },

  get: window.getter,

  refresh: function () {

    var join = this;

    this.component.querySelector( ".table" ).style.transition = "background-color 1s linear,color 1s linear";
    this.component.querySelector( ".table" ).setAttribute( "class" , this.component.querySelector( ".table" ).getAttribute( "class" ) + " refresh" );

    this.initialize();

    if ( this.isSelected ) {
      this.database.showRecords( this.get( this.lastQuery.expr, this.lastQuery.order, this.lastQuery.distinct ) );
    }

    setTimeout( function () {
      join.component.querySelector( ".table" ).setAttribute( "class", join.component.querySelector( ".table" ).getAttribute( "class" ).replace( /refresh/, "" ).replace( / +/, " " ).replace( / $/, "" ) );
      setTimeout( function () {
        join.component.querySelector( ".table" ).style.transition = "none";
      }, 1000 );
    }, 1000 );

  },

  remove: function () {
    if ( confirm( 'Remove "' + this.name + '"?' ) ) {
      this.database.removeJoin( this );
    }
  },

}

/**
Global Spinner Class
*/
var GlobalSpinner = function ( container ) {
  this.container = container;
  this.container.style.position = "absolute";
  this.container.style.top = 0;
  this.container.style.left = 0;
  this.container.style.backgroundColor = "rgba( 255, 255, 255, 0.5 )";
  this.container.style.width = "100%";
  this.container.style.height = "100%";
  this.container.style.zIndex = 1;
  this.container.querySelector( ".globalSpinner-spinner" ).style.position = "absolute";
  this.spinner = this.container.querySelector( ".globalSpinner-spinner" );
}
GlobalSpinner.prototype = {

  container: null,
  spinner: null,

  start: function () {
    this.container.style.height = document.querySelector( "body" ).clientHeight + "px";
    this.spinner.style.top = window.innerHeight / 2 - this.spinner.clientHeight / 2 + "px";
    this.spinner.style.left = window.innerWidth / 2 - this.spinner.clientWidth + "px";
    this.container.style.display = "block";
  },

  stop: function () {
    this.container.style.display = "none";
  }

}

// database
var db;
var globalSpinner;

window.onFoul = function () {

  Script( "js/papaparse.min.js", null, "var module = undefined;" );
  Script( "js/taffy-min.js", null, null, "window.TAFFY = TAFFY;" );

  window.db = new Database( {
    tablesContainer: document.querySelector( ".tables" ),
    conditionContainer: document.querySelector( ".condition" ),
    queryContainer: document.querySelector( ".query" ),
    recordsContainer: document.querySelector( ".records" )
  } );

  window.globalSpinner = new GlobalSpinner( document.querySelector( ".globalSpinner-container" ) );

  document.querySelector( ".button-import" ).addEventListener( "click", function () {
    window.db.importCsv();
  } );

  var forms = document.querySelectorAll( "form" );
  for ( var i = 0; i < forms.length; i++ ) {
    forms[ i ].addEventListener( "submit", function ( event ) {
      event.preventDefault();
      return false;
    } );
  }

}

</script>

</body>
</html>
