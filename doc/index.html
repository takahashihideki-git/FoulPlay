<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Foul Play</title>
<link rel="alternate" type="application/atom+xml" href="http://takahashihideki-git.github.io/FoulPlay/doc/feed.xml" title="Foul Play" />
<link rel="stylesheet" href="../css/bootstrap.min.css"> 
<link rel="stylesheet" href="css/style.css"> 
<style>
.tagline {
	position: absolute;
	top: 65px;
	right: 20px;
	font-size: 100%;
	color: #666;
}
@media ( max-width: 980px ) {
	.tagline {
		display: none;
	}
}
.item {
	padding-bottom: 3em;
	border-bottom: 1px dotted #ccc;
}
.item:last-child {
	border: 0;
}
.title {
	margin-bottom: 0;
}
.pubdate {
	font-size: 80%;
	color: #666;
}
.image {
	width: 320px;
	float: left;
	margin: 0 1em 1em 0;
}
.description p.last {
	display: inline;
}
</style>
</head>
<body>
<header>
	<h1>Foul Play</h1>
	<p class="tagline">Single Page Web Applications with Cross-Origin Resources and Local File System.</p>
</header>

<div class="container">
</div>

<footer>&copy; <a href="https://github.com/takahashihideki-git">takahashihideki</a></footer>

<script class="template template-item" type="text/x-template">
<div class="item">
	<h3 class="title"><a href="{link}">{title}</a></h3>
	<p class="pubdate">{pubdate}</p>
	<div class="description"><a href="{link}"><img class="image" src="{image}"></a>{description} ... <a href="{link}">more</a></div>
</div>
</script>

<script>

var initialize = function ( feed ) {

	var parser = new DOMParser();
	var parsed = parser.parseFromString( feed, "text/xml" );

	// test
	var items = parsed.querySelectorAll( "item" );
	var container = document.querySelector( ".container" );
	for ( var i = 0; i < items.length; i++ ) {

		( function () {

			var title = items[ i ].querySelector( "title" ).textContent;
			var description = items[ i ].querySelector( "description" ).textContent;
			var link = items[ i ].querySelector( "link" ).textContent;
			var image = items[ i ].querySelector( "image" ).textContent;
			var pubdate = items[ i ].querySelector( "pubDate" ).textContent;

			var template = document.querySelector( ".template-item" ).innerHTML;
			image = getFileName( image );
			var html = template.replace( /{image}/, image ? "img/" + image : "" )
							   .replace( /{link}/g, getFileName( link ) )
							   .replace( /{title}/, title )
							   .replace( /{description}/, paragraphize( description ) )
							   .replace( /{pubdate}/, getLocalTime( pubdate ) );
			container.innerHTML = container.innerHTML + html;

		} )();
	}

	var brokenImages = document.querySelectorAll( "img[src='']" )
	for ( var i = 0; i < brokenImages.length; i++ ) {
		brokenImages[ i ].style.display = "none";
	}

}

var getFileName = function ( url ) {
	if ( ! url ) {
		return "";
	}
	var matches = url.match( /[^/]+$/ );
	return matches[ 0 ];
}

var getLocalTime = function ( date ) {
	var d = new Date( date );
	return d.getFullYear() + "-" + zeroPadding( d.getMonth() + 1, 2 ) + "-" + zeroPadding( d.getDate(), 2 ) + " " + zeroPadding( d.getHours(), 2 ) + ":" + zeroPadding( d.getMinutes(), 2 );
}

var zeroPadding = function ( number, length ) {
	return ( "0" + String( number ) ).substr( length * -1 );
}

var paragraphize = function ( text ) {
	return text.split( "。" ).map( function ( value, index, array ) { 
		if ( index == array.length - 1 ) {
			value = "<p class='last'>" + value + "</p>"
		}
		else {
			value = "<p>" + value + "。</p>" 
		}
		return value;
	} ).join( "" );
}

window.onload = function () {

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4) { // DONE
	      initialize( xhr.responseText );
		}
	}
	xhr.open( "GET", "feed.xml" );
	xhr.send();

}

</script>
</body>
</html>
